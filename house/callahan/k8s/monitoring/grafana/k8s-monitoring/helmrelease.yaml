apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: k8s-monitoring
  namespace: monitoring
spec:
  dependsOn:
    - name: istiod
      namespace: istio-system
    - name: tailscale-operator
      namespace: tailscale
    - name: prometheus
      namespace: monitoring
    - name: loki
      namespace: monitoring
  interval: 15m
  releaseName: k8s-monitoring
  chart:
    spec:
      chart: k8s-monitoring
      version: ">= 2.0.13"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: monitoring
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    cluster:
      name: k8s.callahan.house
    destinations:
      - name: prometheus
        type: prometheus
        url: http://prometheus-server/api/prom/push
      - name: loki
        type: loki
        url: http://loki-gateway/loki/api/v1/push
    clusterMetrics:
      enabled: true
    clusterEvents:
      enabled: true
    podLogs:
      enabled: true
    applicationObservability:
      enabled: false
    prometheusOperatorObjects:
      enabled: true
    alloy-metrics:
      enabled: true
    alloy-logs:
      enabled: true
    alloy-singleton:
      enabled: true
